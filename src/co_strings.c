//
// 文字列操作関数群
//

#include "co_strings.h"
#include "co_debug.h"


static int l_unique_ct;


//==============================================================
const char *l_strstr(const char *str, const char *fname)
//--------------------------------------------------------------
// 文字列の切り出し
//--------------------------------------------------------------
// in:	str   = 検索する文字列
//		fname = 検索対象
//--------------------------------------------------------------
// out:	str が一致した次のポインタ(見つからなければそのまま fname を返す)
//==============================================================
{
	char *name;

	if ((name = (char *)strstr(fname, str)) != NULL) {
		return name;
	}

	return fname;
}

//==============================================================
void StrCopyLength(char *dst, int len, const char *src)
//--------------------------------------------------------------
// 指定長の文字列コピー
// ※(指定長 - 1) に必ず '\0' を入れます
//--------------------------------------------------------------
// in:	dst = コピー先
//		len = 文字数
//		src = コピー元
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	strncpy(dst, src, len - 1);
	*(dst + len - 1) = '\0';
}

//==============================================================
const char *StrMakeUniqueName(void)
//--------------------------------------------------------------
// ユニークな文字列を生成する
// (月日_時分秒_x)
// xは１桁です。
//--------------------------------------------------------------
// in:	なし
//--------------------------------------------------------------
// out:	生成された文字列へのポインタ(参照のみ)
//==============================================================
{
	static char buf[64];
	time_t timer;
	struct tm *lt;

	time(&timer);								// 時刻の取得
	lt = localtime(&timer);						// ローカルマシンの時刻に変換

	sprintf(buf, "%02d%02d_%02d%02d%02d_%01x",
			 lt->tm_mon + 1, lt->tm_mday,
			 lt->tm_hour, lt->tm_min, lt->tm_sec,
			 l_unique_ct & 0xf);
	l_unique_ct += 1;

	return buf;
}

//==============================================================
char *StrSkipSpace(char *ptr)
//--------------------------------------------------------------
// ホワイトスペースを飛ばす
//--------------------------------------------------------------
// in:	ptr = 文字列ポインタ
//--------------------------------------------------------------
// out:	次のポインタ
//==============================================================
{
	while((*ptr == ' ') || (*ptr == '\t'))
	{
		ptr += 1;
	}

	return ptr;
}

//==============================================================
char *StrNextToken(char *ptr)
//--------------------------------------------------------------
// 次のトークンへ移動
// ※改行は行末として扱い、そこで解析をストップする
//--------------------------------------------------------------
// in:	ptr = 文字列ポインタ
//--------------------------------------------------------------
// out:	次のポインタ
//==============================================================
{
	while((*ptr != ' ') && (*ptr != '\t') && (*ptr != '\0') && (*ptr != '\n'))
	{
		ptr += 1;
	}

	return StrSkipSpace(ptr);
}

//==============================================================
char *StrNextLine(char *ptr)
//--------------------------------------------------------------
// 次の行を返す
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	次のポインタ(NULL: データ無し)
//==============================================================
{
	while((*ptr != '\n') && (*ptr != '\0'))
	{
		ptr += 1;
	}
	if(*ptr == '\0') return NULL;

	while((*ptr != '\0') && (*(u_char *)ptr < ' '))
	{
		ptr += 1;
	}
	if(*ptr == '\0') return NULL;

	return ptr;
}

//==============================================================
BOOL StrIsComment(char *ptr)
//--------------------------------------------------------------
// コメント行かチェック
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	TRUE = コメント行
//==============================================================
{
	char *p;

	p = StrSkipSpace(ptr);

	return ((*p == '#') || (*p == ';')) ? TRUE : FALSE;
}

//==============================================================
BOOL StrIsTextEnd(char *ptr)
//--------------------------------------------------------------
// テキスト終端かチェック
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	TRUE = テキスト終端
//==============================================================
{
	return ((*ptr == '\n') || (*ptr == '\0')) ? TRUE : FALSE;
}

//==============================================================
BOOL StrIsBlank(char *ptr)
//--------------------------------------------------------------
// ブランクかチェック
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	TRUE = ブランク
//==============================================================
{
	return ((*ptr == ' ') || (*ptr == '\t')) ? TRUE : FALSE;
}

//==============================================================
BOOL StrIsValue(char *ptr)
//--------------------------------------------------------------
// 数字かチェック
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	TRUE = 数字
//==============================================================
{
	char a;

	a = *ptr - '0';
	return ((a >= 0) && (a <= 9)) ? TRUE : FALSE;
}

//==============================================================
BOOL StrIsSJIS(char *ptr)
//--------------------------------------------------------------
// SJISコードか判別
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	TRUE = SJISコード
//==============================================================
{
	u_char a;

	a = *ptr;
	return (((a >= 0x81) && (a <= 0x9f)) || ((a >= 0xe0) && (a <= 0xfc))) ? TRUE : FALSE;
}

//==============================================================
int StrGetTextId(char *dst, char *src)
//--------------------------------------------------------------
// 文字列取得
// 最大 ID_MAXLEN 文字コピー
//--------------------------------------------------------------
// in:	dst = 取得先
//		src = 取得元
//--------------------------------------------------------------
// out:	文字数
//==============================================================
{
	int num;

	num = 0;
	while(!StrIsBlank(src) && !StrIsTextEnd(src) && (*src > ' ') && (num < ID_MAXLEN))
	{
		*dst = *src;
		++dst;
		++src;
		++num;
	}

	if(num < ID_MAXLEN)
		*dst = '\0';

	return num;
}

//==============================================================
int StrGetValue(char *ptr)
//--------------------------------------------------------------
// 数字を変換
// ※データは頭出し済
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	値
//==============================================================
{
#if 1
	return atoi(ptr);
#else
	int a;
	BOOL flag = TRUE;

	a = 0;
	if(*ptr == '-')
	{
		flag = FALSE;
		ptr += 1;
	}
	while(StrIsValue(ptr))
	{
		a = (a * 10) + (*ptr - '0');
		ptr += 1;
	}
	if(!flag)
		a = -a;

	return a;
#endif
}

//==============================================================
REAL StrGetReal(char *ptr)
//--------------------------------------------------------------
// 数字を変換
// ※データは頭出し済
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	値
//==============================================================
{
	return (REAL)atof(ptr);
}

//==============================================================
char *StrSkipValue(char *ptr)
//--------------------------------------------------------------
// 数字をスキップ
//--------------------------------------------------------------
// in:	ptr = 現在のポインタ
//--------------------------------------------------------------
// out:	次のポインタ
//==============================================================
{
	if(*ptr == '-') ptr += 1;
	while(StrIsValue(ptr))
	{
		ptr += 1;
	}

	return ptr;
}

//==============================================================
int StrGetLineLen(char *ptr)
//--------------------------------------------------------------
// １行のサイズを取得(SJISも判別)
//--------------------------------------------------------------
// in:	ptr = データポインタ
//--------------------------------------------------------------
// out:	サイズ(バイト数)
//==============================================================
{
	int len = 0;
	int a;

	while(!StrIsTextEnd(ptr))
	{
		a = StrIsSJIS(ptr) ? 2 : 1;
		len += a;
		ptr += a;
	}

	return len;
}

//===============================================================
int StrBinStrToInt(char *src)
// --------------------------------------------------------------
// Bin型文字列をInt型10進数に変換する
// --------------------------------------------------------------
// @note
//	文字列長はL_ID_FLD_MAXLEN-2まで
//	src[0] = '%'
//===============================================================
{
	int len = (int)strlen(src)-1;
	int ct = 0;
	int dec = 0;

	ASSERT(len>0);
	do
	{
		if (src[len] != '_')
		{
			dec += (src[len]-'0') << ct;
			ct += 1;
		}
		len --;
		ASSERT(ct<=L_ID_FLD_MAXLEN-2);
	}
	while(len>0);

	return dec;
}

//===============================================================
void StrIntToBinStr(char *dst, int src)
// --------------------------------------------------------------
// Int型10進数をBin型文字列に変換する
// --------------------------------------------------------------
// @note
//	文字列長はL_ID_FLD_MAXLEN-2まで
//	dst[0] = '%'
//===============================================================
{
	int bin, _src, len = 0;
	_src = src;
	do
	{
		src = src>>1;
		len += 1;
		ASSERT(len<=L_ID_FLD_MAXLEN-2);
	}
	while(src);

	dst[0] = '%';
	dst[len+1] = '\0';
	src = _src;
	do
	{
		bin = src&1;
		src = src>>1;
		dst[len--] = '0' + (char)bin;
	}
	while(src);
}

//==============================================================
void StrToLower(char *dst)
//--------------------------------------------------------------
// 文字列を小文字へ変換
//--------------------------------------------------------------
// in:	dst = 文字列
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	while(*dst != '\0')
	{
		*dst = (char)tolower(*dst);
		dst += 1;
	}
}

//==============================================================
void StrToUpper(char *dst)
//--------------------------------------------------------------
// 文字列を大文字へ変換
//--------------------------------------------------------------
// in:	dst = 文字列
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	while(*dst != '\0')
	{
		*dst = (char)toupper(*dst);
		dst += 1;
	}
}

