//=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
//
//  < flist >
//   2004 ASTROLL Inc. All Rights Reserved.
//--------------------------------------------------------------
//
//	ディレクトリを再帰的に検索して、ファイル名を表示する
//
//-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
//  $Id: main.c,v 1.3 2004/02/09 12:57:13 nishi Exp $
//-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/********************************************/
/*           インクルードファイル           */
/********************************************/
#include <windows.h>

#include <stdio.h>
#include <stdlib.h>
#include <string.h>


/********************************************/
/*             定数・マクロ宣言             */
/********************************************/


/********************************************/
/*                構造体宣言                */
/********************************************/


/********************************************/
/*                 変数宣言                 */
/********************************************/
static char dirName[256];


/********************************************/
/*                プログラム                */
/********************************************/

//==============================================================
static void l_title(void)
//--------------------------------------------------------------
// タイトル表示
//--------------------------------------------------------------
// in:	なし
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	printf("flist Version 0.1\n");
	printf("Copyright (C) 2004 BitStep All Rights Reserved.\n");
	printf("by Nishiyama Nobuyuki (nishi@bitstep.com)\n");
	printf("\n");
}

//==============================================================
static void l_usage(void)
//--------------------------------------------------------------
// 使い方の表示
//--------------------------------------------------------------
// in:	なし
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	printf("flist [options] directry\n");
}

//==============================================================
static void l_getOption(int argc, char **argv)
//--------------------------------------------------------------
// オプション解析
//--------------------------------------------------------------
// in:	argc = 引数の数
//		argv = 引数のポインタ列
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	char *p;

	dirName[0] = '\0';

	while(argc > 0)
	{
		p = *argv;
		if(*p == '-')
		{
			
			
		}
		else
		{
			// 入力ファイル
			//--------------
			strcpy(dirName, p);
			if(dirName[strlen(dirName) - 1] != '\\')
			{
				strcat(dirName, "\\");
			}
		}

		argv++;
		argc--;
	}
}

//==============================================================
static void l_printDir(char *path)
//--------------------------------------------------------------
// ディレクトリ以下のファイルをまとめて表示
//--------------------------------------------------------------
// in:	path = 検索パス
//--------------------------------------------------------------
// out:	なし
//==============================================================
{
	HANDLE hd;
	WIN32_FIND_DATA fd;
	char file[256];

	strcpy(file, path);
	strcat(file, "*");
	hd = FindFirstFile(file, &fd);
	if(hd == INVALID_HANDLE_VALUE)
	{
		printf("error\n");
		return;
	}

	do
	{
		// 隠しファイルは無視する
		//------------------------
		if(!(fd.dwFileAttributes & FILE_ATTRIBUTE_HIDDEN))
		{
			if(fd.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)
			{
				if(fd.cFileName[0] != '.')
				{
					strcpy(file, path);
					strcat(file, fd.cFileName);
					strcat(file, "\\");

					l_printDir(file);
				}
			}
			else
			{
				printf("%s%s\n", path, fd.cFileName);
			}
		}
	}
	while(FindNextFile(hd, &fd));
}

//==============================================================
int main(int argc, char **argv)
//--------------------------------------------------------------
// メインプログラム
//--------------------------------------------------------------
// in:	argc = 引数の数
//		argv = 引数のポインタ列
//--------------------------------------------------------------
// out:	0 = 処理完了
//==============================================================
{
	// コマンドラインからのオプション解析
	//------------------------------------
	l_getOption(argc - 1, argv + 1);

	if(dirName[0] == '\0')
	{
		l_title();
		l_usage();
		return 1;
	}

	// 実行
	//------
	l_printDir(dirName);

	return 0;
}

